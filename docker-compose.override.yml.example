# Development overrides for docker-compose.yml
# This file is automatically merged with docker-compose.yml in development environments
# It configures services to use development build targets and settings

services:

  php:
    build:
      target: magento2-php
    pull_policy: build
    image: magento2-php
    environment:
      # Override SMTP settings to route all mail through Mailpit
      - CONFIG__DEFAULT__SYSTEM__SMTP__HOST=mailpit
      - CONFIG__DEFAULT__SYSTEM__SMTP__PORT=1025
      - CONFIG__DEFAULT__SYSTEM__SMTP__AUTH=none
      - CONFIG__DEFAULT__SYSTEM__SMTP__SSL=

  web:
    build:
      target: magento2-nginx  # Development: stops at stage 1 (no static assets)
    image: magento2-nginx

  cron:
    build:
      target: magento2-php  # Development: same as php service
    image: magento2-php

  composer:
    build:
      context: .
      dockerfile: docker/composer/Dockerfile
      additional_contexts:
        magento2-php: service:php
    image: magento2-composer
    volumes:
      - ./src:/var/www/html
    profiles:
      - tools

  securetermination:
    volumes:
      # Development: use Caddyfile.dev and mount local mkcert certificates
      - ./docker/caddy/conf/Caddyfile.dev:/etc/caddy/Caddyfile:ro
      - ${CADDY_CERT_FILE:-./certs/cert.pem}:/certs/cert.pem:ro
      - ${CADDY_KEY_FILE:-./certs/key.pem}:/certs/key.pem:ro

  mailpit:
    image: axllent/mailpit:latest
    restart: unless-stopped
    environment:
      # Use the same SMTP credentials Magento is configured with
      - MP_SMTP_AUTH_ACCEPT_ANY=true
      - MP_SMTP_AUTH_ALLOW_INSECURE=true
      - MP_WEBROOT=mailpit
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8025/livez"]
      interval: 30s
      timeout: 5s
      retries: 3

  autoheal:
    profiles:
      - production  # Disabled in development
