name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # â”€â”€â”€ Bootstrap Magento (if source not committed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Check if Magento source code is present
        id: check-source
        run: |
          if [ -f "src/pub/index.php" ]; then
            echo "magento_present=true" >> $GITHUB_OUTPUT
            echo "âœ… Magento source code is present"
          else
            echo "magento_present=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Magento source code not found â€” will bootstrap from scratch"
          fi

      - name: Bootstrap Magento
        if: steps.check-source.outputs.magento_present == 'false'
        run: |
          echo "ðŸš€ Bootstrapping Magento from scratch..."

          # Setup environment files for development
          [ -f ".env" ] || cp .env.example .env
          [ -f "docker-compose.override.yml" ] || cp docker-compose.override.yml.example docker-compose.override.yml

          # Create secrets with dummy values for CI
          mkdir -p docker/secrets
          echo "DummyPassword123" > docker/secrets/db_password.txt
          echo "DummyPassword123" > docker/secrets/mysql_root_password.txt
          echo "DummyPassword123" > docker/secrets/mysql_password.txt
          echo "Admin123456"      > docker/secrets/admin_password.txt
          echo "DummyPassword123" > docker/secrets/smtp_password.txt

          # Download Magento source code
          MAGENTO_VERSION=$(cat .magento-version)
          echo "ðŸ“¥ Downloading Magento $MAGENTO_VERSION..."
          wget -qO- "https://github.com/magento/magento2/archive/refs/tags/${MAGENTO_VERSION}.tar.gz" \
            | tar xzfo - --strip-components=1 -C src/

          # Fix permissions (container runs as www-data UID 1000)
          sudo chown -R 1000:1000 src/

          # Build and install dependencies
          docker compose build php
          docker compose build composer
          docker compose run --rm composer install

          # Start services to generate config.php
          docker compose up -d --wait db opensearch valkey php web varnish cron
          docker compose exec -T php bin/magento app:config:dump scopes themes
          docker compose down

          echo "âœ… Magento bootstrapped"

      # â”€â”€â”€ Validate source code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Validate Magento source code
        run: |
          echo "ðŸ” Validating..."
          errors=0

          for file in src/pub/index.php src/app/etc/config.php; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing: $file"
              errors=1
            fi
          done

          for section in scopes themes; do
            if ! grep -q "'$section' =>" src/app/etc/config.php 2>/dev/null; then
              echo "âŒ config.php missing '$section' section"
              echo "   Run: docker compose exec php bin/magento app:config:dump scopes themes"
              errors=1
            fi
          done

          [ $errors -eq 0 ] && echo "âœ… Validation passed" || exit 1

      # â”€â”€â”€ Validate config.toml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Switch to production mode
        run: |
          # Remove development overrides so we test the production setup
          # (docker-compose.override.yml mounts ./src over the baked-in source)
          rm -f docker-compose.override.yml
          # Remove development .env (will be replaced by setup-env.sh)
          rm -f .env

      - name: Validate infrastructure config
        run: |
          python3 -c "
          import tomllib
          with open('infra/config.toml', 'rb') as f:
              config = tomllib.load(f)

          # Check required sections exist
          assert 'servers' in config, 'Missing [servers] section'
          assert 'production' in config['servers'], 'Missing [servers.production]'
          assert 'domain' in config['servers']['production'], 'Missing servers.production.domain'
          assert 'production' in config, 'Missing [production] section'

          print('âœ… config.toml is valid')
          "

      # â”€â”€â”€ Generate .env from config.toml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Generate .env from config.toml
        run: |
          export DEPLOY_DIR="$(pwd)"
          export ENV=staging
          # Provide dummy secrets for CI
          export ADMIN_PASSWORD="Admin123456"
          export SMTP_PASSWORD="DummyPassword123"
          export DB_PASSWORD="DummyPassword123"
          export MYSQL_ROOT_PASSWORD="DummyPassword123"
          export OPENSEARCH_PASSWORD="DummyStr0ngP@ss!"
          ./infra/setup-env.sh

          echo "Generated .env:"
          cat .env

      # â”€â”€â”€ Build production images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Build production Docker images
        run: |
          set -a && source .env && set +a
          # Build production images (source baked in, no volume mounts)
          docker compose build php web varnish
          echo "âœ… All production images built"

      # â”€â”€â”€ Full stack smoke test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Start full stack
        run: |
          set -a && source .env && set +a

          # Start all services except securetermination (needs real certificates)
          if ! docker compose up -d --wait db opensearch valkey php web varnish cron; then
            echo "âŒ Stack failed to start"
            docker compose ps
            for svc in php web db opensearch; do
              echo "=== $svc logs ==="
              docker compose logs "$svc" --tail=50
            done
            exit 1
          fi

          echo "âœ… All services running"
          docker compose ps

      - name: Smoke test
        run: |
          # Test via the web (nginx) service directly on port 8080
          WEB_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker compose ps -q web))

          echo "Testing http://$WEB_IP:8080/health_check.php..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$WEB_IP:8080/health_check.php" --max-time 30)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Health check failed (HTTP $HTTP_CODE)"
            docker compose logs php --tail=50
            docker compose logs web --tail=50
            exit 1
          fi

          echo "Testing http://$WEB_IP:8080/ ..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$WEB_IP:8080/" --max-time 30)
          echo "Frontend response: HTTP $HTTP_CODE"

          # 200 or 302 (redirect to HTTPS) are both acceptable
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Frontend smoke test passed"
          else
            echo "âš ï¸ Unexpected response code â€” check logs"
            docker compose logs php --tail=30
          fi

      - name: Cleanup
        if: always()
        run: docker compose down -v

      # â”€â”€â”€ PR comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const bootstrapped = '${{ steps.check-source.outputs.magento_present }}' === 'false';

            let body = `## âœ… CI Passed

            **Commit:** \`${sha}\`

            | Check | Status |
            |-------|--------|
            | Magento source validation | âœ… |
            | config.toml validation | âœ… |
            | Docker image build | âœ… |
            | Full stack smoke test | âœ… |
            `;

            if (bootstrapped) {
              body += `
            > â„¹ï¸ Magento was bootstrapped from scratch (source not in repo).
            `;
            }

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existing = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('CI Passed')
            );

            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            };

            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: prNumber });
            }
