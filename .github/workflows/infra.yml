name: Infrastructure

on:
  push:
    branches: [master]
    paths:
      - "infra/**"
      - ".github/workflows/infra.yml"
  workflow_dispatch:

permissions:
  contents: read
  actions: write

env:
  HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Generate SSH key pair
        run: |
          ssh-keygen -t ed25519 -f /tmp/deploy_key -N "" -C "magento2-deploy"
          echo "DEPLOY_SSH_PUBKEY=$(cat /tmp/deploy_key.pub)" >> $GITHUB_ENV
          echo "DEPLOY_SSH_PRIVKEY_PATH=/tmp/deploy_key" >> $GITHUB_ENV

      - name: Load existing SSH key from secrets
        if: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY != '' }}
        run: |
          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          ssh-keygen -y -f /tmp/deploy_key > /tmp/deploy_key.pub
          echo "DEPLOY_SSH_PUBKEY=$(cat /tmp/deploy_key.pub)" >> $GITHUB_ENV
          touch /tmp/deploy_key_existed

      - name: Get GitHub Actions runner registration token
        id: runner-token
        run: |
          TOKEN=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token" \
            | jq -r '.token')
          echo "GITHUB_RUNNER_TOKEN=$TOKEN" >> $GITHUB_ENV
        continue-on-error: true

      - name: Provision infrastructure
        id: provision
        run: ./infra/provision.sh

      - name: Save server IPs and SSH key as GitHub Secrets
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set_secret() {
            local name="$1" value="$2"
            echo "Setting secret $name..."
            curl -s -X GET \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key" \
              -o /tmp/pub_key.json

            KEY_ID=$(jq -r '.key_id' /tmp/pub_key.json)
            PUB_KEY=$(jq -r '.key' /tmp/pub_key.json)

            # Encrypt the secret value using libsodium sealed box
            ENCRYPTED=$(python3 -c "
          from base64 import b64encode, b64decode
          from nacl.public import SealedBox, PublicKey
          public_key = b64decode('$PUB_KEY')
          sealed_box = SealedBox(PublicKey(public_key))
          encrypted = sealed_box.encrypt(b'''$value''')
          print(b64encode(encrypted).decode())
          ")

            curl -s -X PUT \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/secrets/$name" \
              -d "{\"encrypted_value\":\"$ENCRYPTED\",\"key_id\":\"$KEY_ID\"}"
          }

          pip install pynacl -q

          # Save production host IP
          PROD_IP=$(hcloud server ip magento2-production 2>/dev/null || echo "")
          if [ -n "$PROD_IP" ]; then
            set_secret "PRODUCTION_HOST" "$PROD_IP"
            echo "✅ PRODUCTION_HOST set to $PROD_IP"
          fi

          # Save staging host IP
          STAGING_IP=$(hcloud server ip magento2-staging 2>/dev/null || echo "")
          if [ -n "$STAGING_IP" ]; then
            set_secret "STAGING_HOST" "$STAGING_IP"
            echo "✅ STAGING_HOST set to $STAGING_IP"
          fi

          # Save SSH key on first run
          if [ ! -f /tmp/deploy_key_existed ]; then
            set_secret "DEPLOY_SSH_PRIVATE_KEY" "$(cat /tmp/deploy_key)"
            echo "✅ DEPLOY_SSH_PRIVATE_KEY saved"
          fi

          # Save Stalwart admin password if mail was provisioned
          if [ -n "${STALWART_ADMIN_PASSWORD:-}" ]; then
            set_secret "STALWART_ADMIN_PASSWORD" "$STALWART_ADMIN_PASSWORD"
            echo "✅ STALWART_ADMIN_PASSWORD saved"
          fi
