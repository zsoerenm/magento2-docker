name: Build PR Docker Images

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**"
      - "docker/**"
      - "docker-compose.yml"
      - ".github/workflows/build-pr-images.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  build-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          clean: true

      - name: Clean workspace
        run: |
          # Remove leftover files from previous runs (src/ is gitignored)
          rm -rf src/vendor src/app/etc/config.php src/pub/index.php
          echo "âœ… Workspace cleaned"

      - name: Check if Magento source code is present
        id: check-source
        run: |
          if [ -f "src/pub/index.php" ]; then
            echo "magento_present=true" >> $GITHUB_OUTPUT
            echo "âœ… Magento source code is present"
          else
            echo "magento_present=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Magento source code not found - will bootstrap from scratch"
          fi

      - name: Bootstrap Magento if needed
        if: steps.check-source.outputs.magento_present == 'false'
        run: |
          echo "ðŸš€ Bootstrapping Magento from scratch..."

          # Setup environment files for development
          if [ ! -f ".env" ]; then
            cp .env.example .env
            echo "âœ… Created .env from .env.example"
          fi

          if [ ! -f "docker-compose.override.yml" ]; then
            cp docker-compose.override.yml.example docker-compose.override.yml
            echo "âœ… Created docker-compose.override.yml from example"
          fi

          # Create secrets directory with dummy values for build
          # Note: Magento requires passwords with both letters and numbers
          mkdir -p docker/secrets
          echo "DummyPassword123" > docker/secrets/db_password.txt
          echo "DummyPassword123" > docker/secrets/mysql_root_password.txt
          echo "DummyPassword123" > docker/secrets/mysql_password.txt
          echo "Admin123456" > docker/secrets/admin_password.txt
          echo "DummyPassword123" > docker/secrets/smtp_password.txt

          # Download Magento source code
          echo "ðŸ“¥ Downloading Magento source code..."
          MAGENTO_VERSION=$(cat .magento-version)
          echo "Magento version: $MAGENTO_VERSION"

          wget -qO- "https://github.com/magento/magento2/archive/refs/tags/${MAGENTO_VERSION}.tar.gz" \
            | tar xzfo - --strip-components=1 -C src/

          echo "âœ… Magento source code downloaded"

          # Fix permissions for composer (container runs as www-data UID 1000)
          echo "ðŸ”§ Fixing permissions..."
          sudo chown -R 1000:1000 src/

          # Build required services for composer
          echo "ðŸ”¨ Building PHP service..."
          docker compose build php

          echo "ðŸ”¨ Building composer service..."
          docker compose build composer

          # Install Composer dependencies
          echo "ðŸ“¦ Installing Composer dependencies..."
          docker compose run --rm composer install

          echo "âœ… Composer dependencies installed"

      - name: Start Magento for config generation
        if: steps.check-source.outputs.magento_present == 'false'
        run: |
          echo "ðŸ³ Starting Docker containers..."
          echo "Docker Compose will handle startup order and healthchecks..."
          echo "Note: Excluding securetermination (Caddy) - not needed for config generation"

          # Start all services except securetermination (needs certificates we don't have in CI)
          # The --wait flag will wait for services with healthchecks to become healthy
          if ! docker compose up -d --wait db opensearch valkey php web varnish cron; then
            echo ""
            echo "âŒ Docker Compose failed to start containers"
            echo ""
            echo "=== Container status ==="
            docker compose ps
            echo ""
            echo "=== PHP logs ==="
            docker compose logs php --tail=100
            echo ""
            echo "=== Web logs ==="
            docker compose logs web --tail=100
            echo ""
            echo "=== Database logs ==="
            docker compose logs db --tail=50
            echo ""
            echo "=== OpenSearch logs ==="
            docker compose logs opensearch --tail=50
            exit 1
          fi

          echo ""
          echo "âœ… All containers are running and healthy"
          docker compose ps

      - name: Generate config.php with scopes and themes
        if: steps.check-source.outputs.magento_present == 'false'
        run: |
          echo "âš™ï¸  Generating config.php with scopes and themes..."
          docker compose exec -T php bin/magento app:config:dump scopes themes

          echo "âœ… config.php generated successfully"

          # Verify the file was created with required sections
          if grep -q "'scopes' =>" src/app/etc/config.php && grep -q "'themes' =>" src/app/etc/config.php; then
            echo "âœ… Verified: config.php contains scopes and themes"
          else
            echo "âŒ ERROR: config.php is missing required sections!"
            cat src/app/etc/config.php
            exit 1
          fi

      - name: Stop development containers
        if: steps.check-source.outputs.magento_present == 'false'
        run: |
          echo "ðŸ›‘ Stopping development containers..."
          docker compose down
          echo "âœ… Development containers stopped"

      - name: Validate Magento source code
        run: |
          echo "ðŸ” Validating Magento source code..."

          if [ ! -f "src/pub/index.php" ]; then
            echo "âŒ ERROR: Magento source code not found!"
            echo ""
            echo "Expected to find src/pub/index.php but it's missing."
            exit 1
          fi

          if [ ! -f "src/app/etc/config.php" ]; then
            echo "âŒ ERROR: config.php not found!"
            exit 1
          fi

          # Check if config.php contains required 'scopes' and 'themes' sections
          if ! grep -q "'scopes' =>" src/app/etc/config.php; then
            echo "âŒ ERROR: config.php is missing 'scopes' configuration!"
            echo ""
            echo "The config.php file must contain 'scopes' and 'themes' sections for deployment."
            echo "Please run the following command locally and commit the changes:"
            echo ""
            echo "  docker compose exec php bin/magento app:config:dump scopes themes"
            echo ""
            echo "This will add the required 'scopes' and 'themes' configuration to config.php."
            exit 1
          fi

          if ! grep -q "'themes' =>" src/app/etc/config.php; then
            echo "âŒ ERROR: config.php is missing 'themes' configuration!"
            echo ""
            echo "The config.php file must contain 'scopes' and 'themes' sections for deployment."
            echo "Please run the following command locally and commit the changes:"
            echo ""
            echo "  docker compose exec php bin/magento app:config:dump scopes themes"
            echo ""
            echo "This will add the required 'scopes' and 'themes' configuration to config.php."
            exit 1
          fi

          echo "âœ… Magento source code validation passed"
          echo "  - src/pub/index.php exists"
          echo "  - src/app/etc/config.php exists"
          echo "  - config.php contains 'scopes' configuration"
          echo "  - config.php contains 'themes' configuration"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build PHP image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/php/Dockerfile
          tags: magento2-php:pr-${{ github.event.pull_request.number }}
          outputs: type=docker,dest=/tmp/magento2-php.tar

      - name: Build Nginx image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/nginx/Dockerfile
          tags: magento2-nginx:pr-${{ github.event.pull_request.number }}
          outputs: type=docker,dest=/tmp/magento2-nginx.tar

      - name: Build Varnish image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/varnish/Dockerfile
          tags: magento2-varnish:pr-${{ github.event.pull_request.number }}
          outputs: type=docker,dest=/tmp/magento2-varnish.tar

      - name: Upload images as artifacts
        uses: actions/upload-artifact@v6
        with:
          name: docker-images-pr-${{ github.event.pull_request.number }}
          path: /tmp/magento2-*.tar
          retention-days: 7

      - name: Comment on PR with build status
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const sha = '${{ github.event.pull_request.head.sha }}';
            const shortSha = sha.substring(0, 7);
            const wasBootstrapped = '${{ steps.check-source.outputs.magento_present }}' === 'false';

            let bootstrapNote = '';
            if (wasBootstrapped) {
              bootstrapNote = `
            ### ðŸš€ Magento Bootstrapped

            Magento source code was not present in the repository, so it was automatically:
            - Downloaded from GitHub (version from \`.magento-version\`)
            - Installed via Composer
            - Configured with \`app:config:dump scopes themes\`

            **Note**: The generated files are NOT committed to the repository. They exist only for this build.
            `;
            }

            const body = `## âœ… Docker Images Built Successfully

            Docker images have been built for this PR and are ready for deployment.

            - **Commit**: \`${shortSha}\`
            - **PHP Image**: \`magento2-php:pr-${prNumber}\`
            - **Nginx Image**: \`magento2-nginx:pr-${prNumber}\`
            - **Varnish Image**: \`magento2-varnish:pr-${prNumber}\`
            ${bootstrapNote}
            ### Deploy to Test Environment

            To deploy these images to a test server, comment:
            \`\`\`
            /deploy-dev
            \`\`\`

            The deployment will:
            - Provision a Hetzner Cloud server (cx22)
            - Set up HTTPS with Let's Encrypt
            - Auto-shutdown after 1 hour

            ---
            _Images are stored for 7 days_`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Docker Images Built Successfully')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
