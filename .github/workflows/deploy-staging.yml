name: Deploy to Staging

on:
  push:
    branches: [master]
    paths-ignore:
      - "infra/**"
      - "*.md"
      - "docs/**"
      - ".github/workflows/infra.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, staging]
    environment: staging
    env:
      DEPLOY_DIR: /opt/magento2
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Write environment and secrets
        env:
          ENV: staging
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          OPENSEARCH_PASSWORD: ${{ secrets.OPENSEARCH_PASSWORD }}
          STAGING_PASSWORD: ${{ secrets.STAGING_PASSWORD }}
        run: ./infra/setup-env.sh

      - name: Sync repo to deploy directory
        run: |
          rsync -a --delete \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='docker/secrets' \
            "$GITHUB_WORKSPACE/" "$DEPLOY_DIR/"

      - name: Build Docker images
        working-directory: /opt/magento2
        run: |
          set -a && source .env && set +a
          docker compose build

      - name: Deploy
        working-directory: /opt/magento2
        run: |
          set -a && source .env && set +a
          docker compose up -d

          echo "Waiting for services to become healthy..."
          for i in $(seq 1 60); do
            if docker compose ps | grep -q "unhealthy"; then
              sleep 5
            else
              echo "All services healthy!"
              docker compose ps
              exit 0
            fi
          done

          echo "WARNING: Some services may not be healthy yet"
          docker compose ps
