#!/bin/sh
set -ex

# Go through the list of possible arguments and check if a corresponding
# environment variable exists. If yes add it to the list of arguments, that
# is going to be used for `setup:install` or `setup:config:set`.
# `setup:install` will be used if the file `app/etc/env.php` doesn't exist.
# Here an example:
# For the argument `--db-host` the environment variable `DB_HOST` is checked.

magento_help=$(if [ -e app/etc/env.php ]; then \
    php bin/magento setup:config:set --help
else \
    php bin/magento setup:install --help
fi)

args=""

while read line 
do
    env_ref=$(echo $line | awk -v FS="(--|=)" '{print $2}' | awk '{ print toupper($0) }' | tr '-' '_')
    env_var=$(eval echo \$$env_ref)
    arg=$(echo $line | awk -F= '{print $1}')
    
    # Check if argument ends with "password" and look for corresponding _FILE env var
    if [[ "$arg" == *"password"* ]]; then
        env_file_ref="${env_ref}_FILE"
        env_file_path=$(eval echo \$$env_file_ref)
        if [[ ! -z "$env_file_path" && -f "$env_file_path" ]]; then
            env_var=$(cat "$env_file_path")
        fi
    fi
    
    [[ ! -z "$env_var" ]] && args="${args} $arg=${env_var}"
done < <(echo "$magento_help" | sed 's/^[ \t]*//' | tr -d '[' | grep -- "^--.*=")

if [ -e app/etc/env.php ]
then
    php bin/magento setup:config:set ${args}

    # Run database migrations if needed (e.g. after Magento version upgrade)
    if ! php bin/magento setup:db:status > /dev/null 2>&1; then
        echo "âš™ï¸  Database schema is outdated â€” running setup:upgrade..."
        php bin/magento setup:upgrade
        php bin/magento cache:flush
        echo "âœ… Database upgrade complete"
    fi
else
    php bin/magento setup:install ${args}
fi

# Auto-detect HyvÃ¤ theme and disable legacy frontend optimization
# HyvÃ¤ uses Tailwind CSS â€” Magento's built-in JS/CSS bundling/minification conflicts with it
if php bin/magento module:status 2>/dev/null | grep -q "Hyva_Theme"; then
    echo "ðŸŽ¨ HyvÃ¤ theme detected â€” disabling legacy JS/CSS bundling"
    php bin/magento config:set dev/js/merge_files 0
    php bin/magento config:set dev/js/enable_js_bundling 0
    php bin/magento config:set dev/js/minify_files 0
    php bin/magento config:set dev/js/move_script_to_bottom 0
    php bin/magento config:set dev/css/merge_css_files 0
    php bin/magento config:set dev/css/minify_files 0
    php bin/magento config:set dev/template/minify_html 0
    php bin/magento config:set customer/captcha/enable 0
    php bin/magento cache:flush > /dev/null 2>&1
fi

smtp_password="$CONFIG__DEFAULT__SYSTEM__SMTP__PASSWORD_UNENCRYPTED"
if [[ ! -z "$CONFIG__DEFAULT__SYSTEM__SMTP__PASSWORD_UNENCRYPTED_FILE" && -f "$CONFIG__DEFAULT__SYSTEM__SMTP__PASSWORD_UNENCRYPTED_FILE" ]]; then
    smtp_password=$(cat "$CONFIG__DEFAULT__SYSTEM__SMTP__PASSWORD_UNENCRYPTED_FILE")
fi

if [ ! -z "$smtp_password" ]; then
    php bin/magento config:set system/smtp/password ${smtp_password}
fi

"$@"
