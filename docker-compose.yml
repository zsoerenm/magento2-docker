secrets:
  db_password:
    file: ./docker/secrets/db_password.txt
  admin_password:
    file: ./docker/secrets/admin_password.txt
  mysql_root_password:
    file: ./docker/secrets/mysql_root_password.txt
  mysql_password:
    file: ./docker/secrets/mysql_password.txt
  smtp_password:
    file: ./docker/secrets/smtp_password.txt

services:

  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    image: zsoerenm/magento2-php:2.4.7-p3
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    depends_on:
      db:
        condition: service_healthy
        restart: true
      opensearch:
        condition: service_started
      valkey:
        condition: service_started
    volumes:
      - "${DOCKER_MAGENTO_VOLUME:-mediadata:/var/www/html/pub/media}"
    secrets:
      - db_password
      - admin_password
      - smtp_password
    environment:
      - DB_HOST=db
      - DB_USER=${DB_USER}
      - DB_NAME=${DB_NAME}
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - BACKEND_FRONTNAME=${BACKEND_FRONTNAME}
      - ADMIN_USER=admin
      - ADMIN_PASSWORD_FILE=/run/secrets/admin_password
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_FIRSTNAME=${ADMIN_FIRSTNAME}
      - ADMIN_LASTNAME=${ADMIN_LASTNAME}
      - CONFIG__DEFAULT__TRANS_EMAIL__IDENT_GENERAL__NAME=${TRANS_EMAIL_NAME}
      - CONFIG__DEFAULT__TRANS_EMAIL__IDENT_GENERAL__EMAIL=${TRANS_EMAIL_ADDRESS}
      - CONFIG__DEFAULT__SYSTEM__SMTP__TRANSPORT=${SMTP_TRANSPORT}
      - CONFIG__DEFAULT__SYSTEM__SMTP__HOST=${SMTP_HOST}
      - CONFIG__DEFAULT__SYSTEM__SMTP__PORT=${SMTP_PORT}
      - CONFIG__DEFAULT__SYSTEM__SMTP__USERNAME=${SMTP_USERNAME}
      - CONFIG__DEFAULT__SYSTEM__SMTP__PASSWORD_UNENCRYPTED_FILE=/run/secrets/smtp_password
      - CONFIG__DEFAULT__SYSTEM__SMTP__AUTH=${SMTP_AUTH}
      - CONFIG__DEFAULT__SYSTEM__SMTP__SSL=${SMTP_SSL}
      # Set caching application to Varnish (=2) default is 1
      - CONFIG__DEFAULT__SYSTEM__FULL_PAGE_CACHE__CACHING_APPLICATION=2
      - CONFIG__DEFAULT__WEB__SECURE__USE_IN_ADMINHTML=1
      - CONFIG__DEFAULT__WEB__SECURE__USE_IN_FRONTEND=1
      # Firefox and Chrome do not upgrade to https automatically for localhost
      # Hence, create a certificate for a url other than localhost (e.g. magento.local) and
      # add a /etc/hosts entry like
      # 127.0.0.1   magento.local
      - CONFIG__DEFAULT__WEB__SECURE__ENABLE_HSTS=1
      - CONFIG__DEFAULT__WEB__UNSECURE__BASE_URL=http://magento.local
      - CONFIG__DEFAULT__WEB__SECURE__BASE_URL=https://magento.local
      - SEARCH_ENGINE=opensearch
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_ENABLE_AUTH=true
      - OPENSEARCH_USERNAME=admin
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      # Change these values to valkey in 2.4.9
      # see https://experienceleague.adobe.com/en/docs/commerce-operations/configuration-guide/cache/valkey/valkey-pg-cache#
      - CACHE_BACKEND=redis
      - CACHE_BACKEND_REDIS_SERVER=valkey
      - CACHE_BACKEND_REDIS_DB=1
      - PAGE_CACHE=redis
      - PAGE_CACHE_REDIS_SERVER=valkey
      - PAGE_CACHE_REDIS_DB=2
      - SESSION_SAVE=redis
      - SESSION_SAVE_REDIS_HOST=valkey
      - SESSION_SAVE_REDIS_DB=3

  valkey:
    image: valkey/valkey:8.1.4-alpine
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    healthcheck:
      test: valkey-cli ping | grep PONG
      interval: 10s
      timeout: 5s
      retries: 3

  db:
    image: mariadb:11.4.9
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    volumes:
      - dbdata:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 60s
      start_interval: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    secrets:
      - mysql_root_password
      - mysql_password
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql_root_password
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD_FILE=/run/secrets/mysql_password

  # Eventually make this a cluster.
  # See https://opensearch.org/docs/latest/install-and-configure/install-opensearch/docker/
  opensearch:
    image: opensearchproject/opensearch:3.3.2
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_PASSWORD}
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearchdata:/usr/share/opensearch/data

  web:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    image: zsoerenm/magento2-nginx:2.4.7-p3
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    depends_on:
      - php
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health_check.php"]
      start_period: 5m
      start_interval: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - "${DOCKER_MAGENTO_VOLUME:-mediadata:/var/www/html/pub/media:ro}"
    environment:
      - BACKEND_HOST=php
      - SERVER_NAME=web

  varnish:
    build:
      context: .
      dockerfile: docker/varnish/Dockerfile
    image: zsoerenm/magento2-varnish:2.4.7-p3
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    depends_on:
      web:
        condition: service_healthy
    tmpfs:
      - /var/lib/varnish/varnishd:exec
    environment:
      - BACKEND_HOST=web
      - BACKEND_PORT=8080
      - VARNISH_HOST=web

  cron:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    image: zsoerenm/magento2-php:2.4.7-p3
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    depends_on:
      - php
      - db
    volumes:
      - "${DOCKER_MAGENTO_VOLUME:-mediadata:/var/www/html/pub/media}"
    entrypoint: "/usr/bin/supercronic /etc/crontab"
  
  securetermination:
    image: caddy:2.10.2-alpine
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    depends_on:
      - varnish
    healthcheck:
      test: nc -z localhost 80 && nc -z localhost 443
      start_period: 30s
      start_interval: 10s
      interval: 10s
      timeout: 10s
      retries: 3
    environment:
      - CADDY_EMAIL=${CADDY_EMAIL:-}
      - DOMAIN=${DOMAIN:-localhost}
    volumes:
      - ./docker/caddy/conf:/etc/caddy:ro
      # Production: Let's Encrypt stores certificates here
      - caddy_data:/data
      - caddy_config:/config
      - "${DOCKER_MAGENTO_VOLUME:-mediadata:/var/www/html/pub/media:ro}"
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"

  autoheal:
    image: willfarrell/autoheal
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  dbdata:
  mediadata:
  configdata:
  opensearchdata:
  caddy_data:
  caddy_config:
